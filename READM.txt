#ozon-spidrector
PRJCT: Авто корректировщик цен OZON с динамическим парсингом


## ЗАПУСК:
1. ЗАПУСТИТЬ get_data-api.py и дождаться завершения
2. ОТКРЫТЬ in/products_update_full.xlsx
3. ВЫБРАТЬ ПОЗИЦИИ КОТОРЫЕ НУЖНО КОРРЕКТИРОВАТЬ И СОХРАНИТЬ СПИСКОМ OZON ID В get/get_new.txt
4. ЗАПУСТИТЬ format.py и дождаться завершения
5. ЗАПУСТИТЬ pars_link.py и дождаться завершения
6. ЗАПУСТИТЬ search_bad_pryce.py и дождаться завершения
7. ЗАПУСТИТЬ update_price.py работает бесконечно в цикле.


## СОСТАВ:

### config.py
Прописаны некоторые константы

### .env
API KEY - АПИ ключ

### get_data-api.py: 
(ДЛЯ РАБОТЫ ОБЯЗАТЕЛЬНО НАЛИЧИЕ ФАЙЛА in/opt_all.xlsx с актуальными ценами и товаров. столбцы 'АРТИКУЛ' = КОД 1С, 'Название товара', 'Цена' (ОПТОВАЯ)). 
На выходе создаёт таблицу product_update_full.xlsx в которой будут прописаны:
	"Ozon Product ID": "Ozon Product ID",        
	"SKU": "SKU",
        "Артикул": "Артикул",
        "product_link": "Ссылка на товар",
        "Название товара": "Название товара",
        "Статус товара": "Статус товара",
        "Доступно к продаже по схеме FBS, шт.": "Доступно FBS",
        "Видимость на Ozon": "Видимость",
        "Причины скрытия": "Причины скрытия",
        "Дата создания": "Дата создания",
        "base_price": "Базовая цена API",
        "old_price": "Старая цена API",
        "marketing_price": "Маркетинговая цена API",
        "min_price": "Минимальная цена API",
        "Цена": "Цена 1С".

### format.py: 
(ДЛЯ РАБОТЫ ОБЯЗАТЕЛЬНО НАЛИЧИЕ ФАЙЛА get/get_new.txt и in/products_update_full.xlsx)
Программа берет (список "Ozon Product ID" или "SKU" или "Артикул" товаров для обработки. Каждая запись с новой строки.) и таблицу in/products_update_full.xlsx.
Находит в products_update_full.xlsx совпадения в колонках "Ozon Product ID" или "SKU" или "Артикул". Сохраняет в новую таблицу с найденными строками. Новая таблица сохраняется в in/1_1_product.xlsx.

### pars_link.py:
(ДЛЯ РАБОТЫ ОБЯЗАТЕЛЬНО НАЛИЧИЕ ФАЙЛА in/1_1_product.xlsx)
Переходит по каждой ссылке в файле и сохраняет цену по карте озон и сохраняет найденные данные в новую табличку out/result_price_{time.strftime('%Y%m%d_%H%M%S')}.xlsx
Возможность добавить прокси, создать текстовый файл со списком прокси серверов.

Что нужно сделать в этом файле: 
Добавить возможность вызова необходимых функций этого файла другими модулями. Нужна возможность чтобы этот модуль можно было вызвать сторонними модулями и передать таблицу (как реализовано сейчас) или .csv (этот файл должен будет создаваться с помощью интерфейса который еще не написан) или единичный товар.

### search_bad_pryce.py: (ИЗБАВИТЬСЯ ПОСЛЕ НАСТРОЙКИ IMPUT)
(ДЛЯ РАБОТЫ ОБЯЗАТЕЛЬНО НАЛИЧИЕ ФАЙЛА result_price_(\d{8}_\d{6})\.xlsx)
этот файл проверяет % погрешности у товаров, насколько сильно цена по карте озон которая парсится отличается от оптовой цены, и создаёт текстовый файл bad_price_{timestamp}.txt со списком всех обнаруженных товаров у которых процен погрешности выше или ниже от указанной в коде.  

### update_price.py:
Этот модуль при запуске проверяет наличие текстового файла inwor.txt если его нет, берет на вход bad_price_{timestamp}.txt с последней датой и создаёт постоянный текстовый файл inwork.txt. Из файла программа переходит по каждой ссылке по списку и находит цену по карте озон, обновляет в файле, проверяет процент расхождения, в зависимости от уровня расхождения выбирает нужную формулу прописанную в коде, высчитывает какую новую цену нужно проставить по API и обновляет цену по API. Снова проверяет парсингом как обновилась цена, и так до трёх раз и переход к следующему товару. После того как весь список будет выполнен программа ожидает 40 минут и снова запускается. А также поддерживает работу со списком прокси и асинхронную и параллельную работу.
Возможность добавить прокси, создать текстовый файл со списком прокси серверов.

### correct_price.py: ДОП МОДУЛЬ ДЛЯ ИНТЕГРАЦИЙ    !!! МОЖНО ИСПОЛЬЗОВАТЬ ДЛЯ ОПЕРАТИВНОГО ИЗМЕНЕНИ Я ЦЕН ИЛИ АКЦИЙ. Восстановлена работа с ценами и акциями. ПОСЛЕДНЕЕ ОБНОВЛЕНИЕ 21.11.25
БЫЛО: Этот модуль с простым интерфейсом который позволяет ввести в строку ID номер товара, увидеть все возможные поля с ценами по этому товару которые можно обновлять. И можно посмотреть участвует ли товар в акциях а также увидеть акции которые можно подключить к товару и подключить или отключить акции от товара.


## ВОЗМОЖНЫЕ ПРОБЛЕМЫ:
- В случае перезагрузки сервера, просто запустить update_price.py заново.
- Если данные которые создаёт программа пропали то пройти все шаги запуска сначала.
- Могут возникать ошибки при проверки цен (парсинг цен на страницах товаров), в случае когда ozon обновляют капчу или селектор где лежит цена.
(Для исправлений функции для обхода блокировок и список селекторов в коде)
- Могут возникать ошибки при работе с запросами API. Это касается всех остальных операций кроме парсинга.
(В случае ошибок с ключем по API, в личном кабинете, удалить и пересоздать и прописать в .env новый ключ)
(В случае ошибок с методами по API смотреть обновленную документацию метода на ozon и править метод вызова в коде.)
 


!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!			ДЛЯ РАЗРАБОТКИ			!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!


### correct_stocks.py: ДОП МОДУЛЬ ДЛЯ ИНТЕГРАЦИИ   					!!! НЕ РАБОЧИЙ
Этот модуль с простым интерфейсом который позволяет ввести в строку ID номер товара, увидеть участвует ли товар в акциях а также увидеть акции которые можно подключить к товару и подключить или отключить акции от товара. Остальной функционал с операциями над ценами по товару не реализован.

### correct_megal.py: интерфейс и объединение модулей. НЕ ДОПИСАН 		!!! НЕ РАБОЧИЙ


## ЧТО НУЖНО ДОПИСАТЬ:
1. 
- get_data-api.py нужно частично перенести функционал (enrich_products_with_prices, find_price_for_product, load_opt_prices) в format.py, а в этом модуле оставить только точную выгрузку данных о товарах и сохранение в таблицу. Еще нужно добавить чтобы помимо xlsx данные сохранялись с более быстрый и удобный формат out/data.csv с которым будут работать другие модули. Еще нужно добавить возможность вызова этого модуля из интерфейса в будущем. настроить все корректно в обоих файлах. Дополнительно в этот модуль нужно добавить выгрузку из csv отчёта вот этих колонок "Доступно к продаже по схеме FBO, шт.", "Зарезервировано, шт", "Доступно к продаже по схеме FBS, шт.",	"Доступно к продаже по схеме realFBS, шт.", "Зарезервировано на моих складах, шт", "Рейтинг", "Отзывы".

- в format.py нужно добавить функции из get_data-api.py и настроить все корректно в обоих файлах. И обязательно добавить возможность вызова необходимых функций format.py другими модулями. Добавить возможность что при получении пустого списка или отсутствия текстового файла get/get_new.txtget/get_new.txt программа должна обработать все товары и сохранить в in/1_1_product.xlsx. Важно сохранить все колонки и данные в них при работе с product_update_full.xlsx.

2.
 pars_link.py Добавить возможность вызова необходимых функций этого файла другими модулями. Нужна возможность чтобы этот модуль можно было вызвать сторонними модулями и передать таблицу (как реализовано сейчас) (этот файл должен будет создаваться с помощью интерфейса который еще не написан) или единичный товар. После обновления групп товаров модуль должен сохранить или обновить данные в out/data.csv и out/result_price_{time.strftime('%Y%m%d_%H%M%S')}.xlsx.


3. 
	1. Объеденить рабочий фукнционал из correct_stocks.py и correct_price.py в один файл и 


	2. добавить новые возможности:
- В интерфейсе должна быть возможность открыть таблицу запускать модуль get_data-api.py в этом случае после оканчания работы модуля должны появиться или обновиться данные в out/data.csv. Дождаться когда обновиться этот файл и загрузить его в интерфейсе в табличном виде, со всеми колонками и с динамическим отображением в окне программы не залазя за края и на кнопки. Таблица должна быть с возможностью фильтрации любого столбика и динамической фильтрацией с несколькими фильтрами. В таблице у каждой строчки в которой есть данные должен быть чек бокс и кнопка с возможностью выделить только отфильтрованные товары. Таблица должна загружать сразу все данные, для просмотра пользователь смотрит товары как длинный лендинг. Должна быть возможность скрывать или отображать колонки с данными, чтобы вся таблица сразу влезла по ширине нужно отображать:
        "Название товара": "Название товара",
        "base_price": "Базовая цена API",
        "old_price": "Старая цена API",
        "marketing_price": "Маркетинговая цена API",
        "min_price": "Минимальная цена API",
        "Цена": "Цена 1С".
остальные колонки должны быть скрыты но с возможностью отобразить с помощью всплывающего списка  сколонками при наведенни мышкой на нужное меню, это нужно реализовать. Чек боксы напротив каждой строки с данными должны работать так: чек бокс можно поставить или снять на один товар или на отфильтрованные товары по кнопке. Если поставлен хотябы один чек бокс то отобразиться кнопки "Начать корректировку цен" и "Обновить данные о ценах по карте озон". 
Если нажать на кнопку "Обновить данные о ценах по карте озон" то нужно сформировать текстовый файл in/inter_check_up.txt со списком ссылок и Ozon Product ID напротив каждой ссылки. Передать список ссылок по специальному параметру в pars_link.py, а на выходе через некоторое время я буду получать обновленные цены "С Ozon картой" сразу в таблицу out/data.csv и в интерфейс и в таблицу out/result_price_{time.strftime('%Y%m%d_%H%M%S')}.xlsx.
Если нажать на кнопку "Начать корректировку цен" то тут пока pass


